# Lab3 NodeJs SQL Injection Vulnerability

## Ambiente

### Programas Necessários

* VS Code;
* Node JS;
* Postman;
* sqlectron;
* Docker (opcional).
* MySQL (necessário somente se não possuir Docker);

## Como executar a Aplicação

### Manualmente

#### Banco de Dados

1. Executar serviço MySQL;
2. Criar um banco de dados chamado `lab3`;
3. Criar um usuário chamado `test` e senha `test`;
4. Execute o script `init.sql` para criar a estrutura básica.

#### Aplicação

1. Execute o comando `npm install`;
2. Execute o comando `node app.js`.

### Usando Docker

#### Banco de Dados + Aplicação

Através do Docker, é possível executar a aplicação e o Banco de Dados em containers, com abstração de instalação de ambiente e preparação de banco de dados.

1. Executar o comando `docker-compose up`.

#### Somente Banco de Dados
1. Executar o comando `docker-compose up db`.

#### Somente Aplicação
1. Executar o comando `docker-compose up app`.

## Mitigando as vulnerabilidades

### Exposição de informações de exceptions para o frontend

1. Altere a implementação da rota `GET /auth` do `app.js` para retornar um erro `500` utilizando a mensagem da exception encontrada , ex.:
    ```javascript
    try {
        const users = await db.selectUserByLogin(req.query.user, req.query.password);

        if(users.length){
        res.send("Login Success");
        }else{
        res.status(401).send("Unauthorized");
        }
    } catch (e) {
        res.status(500).send(e);
        next(e)
    }
    ```
2. Na função `selectUserByLogin` do `db.js`, altere a implementação para tratar exceptions recebidas, logando mais detalhes do erro ocorrido e retornando um erro genérico para as camadas superiores, ex.:
    ```javascript
    try{
        const [rows, fields] = await conn.query(query, [user, password]);
        console.log("Retorno SQL: " + JSON.stringify(rows));
        return rows;
    }catch(err){
        console.log("Erro SQL: " + err);
        throw'Erro Inesperado';
    }
    ```

### SQL Injection

1. Altere a conexão com o Banco de Dados para utilizar um usuário específico da aplicação ao invés do `root`;
2. Garanta que este usuário de aplicação possua uma senha segura e que possua somente os acessos estritamente necessários para que a aplicação funcione, use o DDL do banco de dados para tais, ex.:
   ```sql
   CREATE USER 'test'@'localhost' IDENTIFIED BY 'newpassword'; # Utilize uma senha forte para previnir ataques Brute force
   FLUSH PRIVILEGES;
   GRANT ALL PRIVILEGES ON `lab2`.* TO 'test'@'localhost'; # Permite todos os privilegios (SELECT, INSERT, UPDATE e DELETE) para todas as tabelas do db lab2
   FLUSH PRIVILEGES;
   ```
3. Altere a implementação das funções de bancos de dados para utilizar Prepared Statements ao invés de concatenar a query, ex.:
   ```javascript
    const query = `SELECT * FROM users WHERE user = ? AND password = ?;`;
    console.log(`Executando query: ${query}`);

    try{
        const [rows, fields] = await connection.query(query, [user, password]);
        console.log("Retorno SQL: " + JSON.stringify(rows));
        return rows;
    }catch(err){
        console.log("Erro SQL: " + err);
        throw'Erro Inesperado';
    }
   ```
4. (Opcional) Altere a implementação para validar os dados recebidos pela API antes de processa-las.

### Evil RegEx (ReDoS)

1. Altere a implementação para validar o usuário iserido antes deutiliza-lo como parâmetro para a próxima RegEx:
```javascript

  if (!userName.match(/^[A-Za-z0-9]+$/))
  {
      res.status(400).json({ message: 'Usuário inválido, por favor utilize somente letras e/ou números!'}).send();
  }
```
1. Altere a implementação para validar a senha iserida antes de utiliza-la:
```javascript

  if (!passoword.match(/^[A-Za-z0-9]+$/))
  {
      res.status(400).json({ message: 'Usuário inválido, por favor utilize somente letras e/ou números!'}).send();
  }
```