# Lab3 NodeJs SQL Injection Vulnerability

## Ambiente

### Programas Necessários

* VS Code;
* Node JS;
* Postman;
* sqlectron;
* Docker (opcional).
* MySQL (necessário somente se não possuir Docker);

## Como executar a Aplicação

### Usando Docker

#### Banco de Dados + Aplicação

Através do Docker, é possível executar a aplicação e o Banco de Dados em containers, com abstração de instalação de ambiente e preparação de banco de dados.

1. Executar o comando `docker-compose up`.

#### Somente Banco de Dados
1. Executar o comando `docker-compose up db`.

#### Somente Aplicação
1. Executar o comando `docker-compose up app`.

### Manualmente

#### Banco de Dados

1. Executar serviço MySQL;
2. Criar um banco de dados chamado `lab3`;
3. Criar um usuário chamado `test` e senha `test`;
4. Execute o script `init.sql` para criar a estrutura básica.

#### Aplicação

1. Execute o comando `npm install`;
2. Execute o comando `node app.js`.


## Explorando as vulnerabilidades

1. Execute banco de dados através do comando: `docker-compose up db` e a aplicação: `nodemon app.js`;

### SQL Injection

* Para executar os passos abaixo, utilize a request `SQL Injection` presente na collection presente no repositório.

1. Tente efetuar login com usuário `usuarioErrado` e senha `senhaInventada`, repare que você receberá um erro 401;
2. Tente efetuar login com usuário `usuarioErrado` e senha `senhaInventada" OR 1=1 -- ` (necessário que seja URL Encoded: `senhaInventada%22%20OR%201%3D1%20--%20`), repare que você receberá um sucesso, mesmo o usuário e senha sendo inválidos.

### Evil RegEx (ReDoS)

* Para executar os passos abaixo, utilize a request `ReDoS` presente na collection presente no repositório.

1. Tente efetuar login com usuário `usuarioErrado` e senha `senhaInventada`, repare que você receberá um erro 401;
2. Tente efetuar login com usuário `usuarioErrado` e senha `senhaInventada" OR 1=1 -- ` (necessário que seja URL Encoded: `senhaInventada%22%20OR%201%3D1%20--%20`), repare que você receberá um sucesso, mesmo o usuário e senha sendo inválidos.

## Mitigando as vulnerabilidades

### SQL Injection

1. Altere a conexão com o Banco de Dados para utilizar um usuário específico da aplicação ao invés do `root`;
2. Garanta que este usuário de aplicação possua uma senha segura e que possua somente os acessos estritamente necessários para que a aplicação funcione, use o DDL do banco de dados para tais no arquivo init.sql, ex.:
   ```sql
   CREATE USER 'test'@'%' IDENTIFIED BY 'newpassword'; # Utilize uma senha forte para previnir ataques Brute force
   FLUSH PRIVILEGES;
   GRANT ALL PRIVILEGES ON `lab3`.* TO 'test'@'%'; # Permite todos os privilegios (SELECT, INSERT, UPDATE e DELETE) para todas as tabelas do db lab3
   FLUSH PRIVILEGES;
   ```
3. No arquivo `db.js`, altere a criação da connection para utilizar o usuário e a senha criados;
4. Altere a implementação das funções de bancos de dados para utilizar Prepared Statements ao invés de concatenar a query, ex.:
   ```javascript
    const query = `SELECT * FROM users WHERE user = ? AND password = ?;`;
    console.log(`Executando query: ${query}`);

    try{
        const [rows, fields] = await connection.query(query, [user, password]);
        console.log("Retorno SQL: " + JSON.stringify(rows));
        return rows;
    }catch(err){
        console.log("Erro SQL: " + err);
        throw'Erro Inesperado';
    }
   ```
4. (Opcional) Altere a implementação para validar os dados recebidos pela API antes de processa-las.

### Evil RegEx (ReDoS)

1. Altere a implementação para validar o usuário inserido antes de utiliza-lo como parâmetro para a próxima RegEx:
```javascript

  if (!userName.match(/^[A-Za-z0-9]+$/))
  {
      res.status(400).json({ message: 'Usuário inválido, por favor utilize somente letras e/ou números!'}).send();
  }
```
1. Altere a implementação para validar a senha iserida antes de utiliza-la:
```javascript

  if (!passoword.match(/^[A-Za-z0-9]+$/))
  {
      res.status(400).json({ message: 'Usuário inválido, por favor utilize somente letras e/ou números!'}).send();
  }
```